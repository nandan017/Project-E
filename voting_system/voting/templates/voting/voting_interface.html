{% extends 'voting/base.html' %}

{% block content %}
{# Font import for 'Satoshi' from Fontshare CDN #}
<link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&display=swap" rel="stylesheet">

<div class="container-fluid px-2 px-md-3">
    <header class="page-header text-center my-4">
        <h2>Vote for 10 Candidates</h2>
    </header>
    
    {# MODIFIED: Sticky header with enhanced glassmorphism #}
    <div class="progress-container">
        <span id="vote-count" class="vote-count">0 / 10 Voted</span>
        {# MODIFIED: Single, continuous progress bar #}
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progress-bar-fill"></div>
        </div>
    </div>

    <form method="POST" action="{% url 'voting_interface' %}">
        {% csrf_token %}
        <div class="form-group mb-5 mx-auto" style="max-width: 400px;">
            <label for="student_id" class="form-label">Student ID</label>
            <input type="text" class="form-control" id="student_id" name="student_id" value="{{qr_code}}" readonly>
            <input type="hidden" name="qr_code" value="{{ qr_code }}">
        </div>

        <input type="hidden" name="selected_candidates" id="selected-candidates">

        <div class="row">
            {% for candidate in candidates %}
            <div class="col-6 col-sm-4 col-md-1-7 mb-4"> 
                <div class="card candidate-card h-100" data-candidate="{{ candidate.candidate_key }}">
                    <div class="card-img-container">
                        <img src="{{ candidate.image.url }}" class="card-img-top" alt="{{ candidate.name }}">
                    </div>
                    <div class="card-body text-center p-2">
                        <p class="card-title mb-0">{{ candidate.name }}</p>
                        <input class="form-check-input" type="checkbox" name="candidate_ids" id="candidate_{{ candidate.pk }}" value="{{ candidate.pk }}">
                    </div>
                    <div class="tick-symbol-container">
                        <span class="tick-symbol">✔️</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </form>
</div>

{# Dialogs remain structurally the same, but will be styled by the new CSS #}
<div id="confirmation-dialog" style="display: none;">
    <div class="dialog-content">
        <h4>Confirm Your Vote</h4>
        <p>You have selected 10 candidates. Are you sure you want to submit your vote?</p>
        <button id="confirm-submit" class="btn btn-primary">Yes, Submit Vote</button>
        <button id="cancel-submit" class="btn btn-secondary">Cancel</button>
    </div>
</div>

<div id="nota-confirmation-dialog" style="display: none;">
    <div class="dialog-content">
        <h4>Confirm Your Choice</h4>
        <p>By choosing "NOTA", you acknowledge that you are opting not to vote for the remaining candidates. Are you sure?</p>
        <button id="confirm-nota" class="btn btn-warning">Yes, I Understand</button>
        <button id="cancel-nota" class="btn btn-secondary">Cancel</button>
    </div>
</div>


<style>
    :root {
        --background-color: #F9FAFB;
        --card-background: #FFFFFF;
        --text-primary: #1F2937;
        --text-secondary: #6B7280;
        --border-color: #E5E7EB;
        --green-primary: #10B981; /* Softer, modern green */
        --blue-accent: #3B82F6;   /* Subtle accent blue */
    }

    body {
        font-family: 'Satoshi', sans-serif;
        background-color: var(--background-color);
        color: var(--text-primary);
    }

    .page-header h2 {
        font-weight: 700;
        font-size: 2.25rem;
        color: var(--text-primary);
    }

    /* --- Custom 7-Column Layout --- */
    .col-md-1-7 {
        flex: 0 0 auto;
        width: 14.2857%;
    }
    @media (max-width: 1199.98px) { .col-md-1-7 { width: 20%; } }
    @media (max-width: 991.98px) { .col-md-1-7 { width: 33.3333%; } }
    @media (max-width: 767.98px) { .col-md-1-7 { width: 50%; } }


    /* --- Candidate Card & Interactions --- */
    .candidate-card {
        background-color: var(--card-background);
        border: 2px solid var(--border-color);
        border-radius: 16px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        /* Transitions for all animated properties */
        transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-color 0.2s ease-in-out;
    }
    
    .candidate-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.07), 0 8px 10px -6px rgba(0, 0, 0, 0.07);
    }
    
    /* "Press Down" effect on click */
    .candidate-card:active {
        transform: translateY(-2px) scale(0.98);
        box-shadow: 0 4px 10px -4px rgba(0, 0, 0, 0.06);
    }

    .candidate-card.selected {
        border-color: var(--green-primary);
    }
    
    /* --- Image with Gradient Overlay --- */
    .card-img-container {
        position: relative;
    }
    
    .card-img-container::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 50%;
        background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
        pointer-events: none; /* Allows clicking through the gradient */
        border-radius: 0 0 12px 12px;
    }

    .card-img-top {
        width: 100%;
        aspect-ratio: 3 / 4; 
        object-fit: cover;
        display: block;
    }
    
    .card-body {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 2;
    }

    .card-title {
        font-size: 1rem;
        font-weight: 500;
        color: #FFFFFF;
        text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    
    .form-check-input { display: none; }
    
    /* --- Animated Tick Symbol --- */
    .tick-symbol-container {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 3;
    }
    .tick-symbol {
        font-size: 1.2rem;
        color: #fff;
        background-color: var(--green-primary);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        /* Initial animation state: hidden */
        opacity: 0;
        transform: scale(0.5);
        transition: opacity 0.2s ease-out, transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .candidate-card.selected .tick-symbol {
        opacity: 1;
        transform: scale(1);
    }
    
    /* --- Single, Smooth Progress Bar & Glassmorphism Header --- */
    .progress-container {
        position: sticky;
        top: 0;
        padding: 12px 20px;
        background-color: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        z-index: 1000;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
        text-align: center;
    }

    .progress-bar-container {
        width: 100%;
        max-width: 600px;
        height: 8px;
        background-color: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
        margin: 8px auto 0;
    }

    .progress-bar-fill {
        width: 0%; /* Controlled by JS */
        height: 100%;
        background-color: var(--green-primary);
        border-radius: 4px;
        transition: width 0.4s cubic-bezier(0.23, 1, 0.32, 1); /* Smooth fill animation */
    }
    
    .vote-count {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-secondary);
    }

    /* --- Dialog Styles --- */
    #confirmation-dialog, #nota-confirmation-dialog {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none; align-items: center; justify-content: center;
        z-index: 1001;
    }
    .dialog-content {
        background-color: white; padding: 2.5rem; border-radius: 16px;
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.15); text-align: center;
        max-width: 450px; margin: 1rem;
    }
</style>


<script>
    let progressCount = 0;
    const totalSegments = 10;
    let selectedCandidates = [];

document.addEventListener('DOMContentLoaded', function() {
    const candidateCards = document.querySelectorAll('.candidate-card');
    const selectedCandidatesInput = document.getElementById('selected-candidates');

    const confirmationDialog = document.getElementById('confirmation-dialog');
    const confirmButton = document.getElementById('confirm-submit');
    const cancelButton = document.getElementById('cancel-submit');

    const notaConfirmationDialog = document.getElementById('nota-confirmation-dialog');
    const confirmNotaButton = document.getElementById('confirm-nota');
    const cancelNotaButton = document.getElementById('cancel-nota');

    candidateCards.forEach(card => {
        card.addEventListener('click', function() {
            const checkbox = card.querySelector('.form-check-input');
            const candidateId = card.getAttribute('data-candidate');
            
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                if (selectedCandidates.length < totalSegments) {
                    selectedCandidates.push(candidateId);
                    progressCount++;
                    card.classList.add('selected');
                } else {
                    alert('You can only select up to 10 candidates!');
                    checkbox.checked = false;
                }
            } else {
                selectedCandidates = selectedCandidates.filter(id => id !== candidateId);
                progressCount--;
                card.classList.remove('selected');
            }

            updateProgressBar();
            selectedCandidatesInput.value = selectedCandidates.join(',');

            if (selectedCandidates.length === 10) {
                confirmationDialog.style.display = 'flex';
            } else if (selectedCandidates.includes("a9aa0b36-f95e-41cc-b71b-c30b3a8f8957")) {
                notaConfirmationDialog.style.display = 'flex';
            } else {
                confirmationDialog.style.display = 'none';
            }
        });
    });

    confirmButton.addEventListener('click', () => document.querySelector('form').submit());
    cancelButton.addEventListener('click', () => confirmationDialog.style.display = 'none');
    confirmNotaButton.addEventListener('click', () => document.querySelector('form').submit());
    cancelNotaButton.addEventListener('click', () => notaConfirmationDialog.style.display = 'none');
});

// REWRITTEN: Controls the new single progress bar
function updateProgressBar() {
    const progressBarFill = document.getElementById('progress-bar-fill');
    const voteCount = document.getElementById('vote-count');
    
    // Calculate percentage for the fill
    const percentage = (progressCount / totalSegments) * 100;
    
    // Update the width of the fill element
    progressBarFill.style.width = `${percentage}%`;

    // Update the vote count text
    voteCount.innerText = `${progressCount} / ${totalSegments} Voted`;
}
</script>
{% endblock %}